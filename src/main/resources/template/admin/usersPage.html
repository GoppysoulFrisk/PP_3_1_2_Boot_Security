<!doctype html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <title>Admin Panel</title>
</head>
<body>

<header class="bg-dark d-flex justify-content-between align-items-center py-2 px-4">
    <div class="d-flex align-items-center">
        <span class="text-light me-2" th:text="${#authentication.name}"></span>
        <span class="text-light me-2">with roles:</span>
        <span class="text-light me-2"
              th:text="${@templatesUtil.getRolesStringFromAuthorities(#authentication.authorities)}">ADMIN USER</span>
    </div>
    <a href="/logout" class="btn btn-outline-light">Logout</a>
</header>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar" style="min-height: 100vh;">
            <div class="position-sticky">
                <ul class="nav flex-column pt-3">
                    <li class="nav-item">
                        <a sec:authorize="hasRole('ADMIN')" href="/admin" class="nav-link" th:classappend="${currentPath == '/admin' ? 'active' : ''}" >
                            Admin
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/user" class="nav-link" th:classappend="${currentPath == '/user' ? 'active' : ''}">
                            User
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Admin panel</h1>
            </div>

            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-link active" id="nav-users-tab" data-bs-toggle="tab" href="#nav-users" role="tab">Users table</a>
                    <a class="nav-link" id="nav-new-user-tab" data-bs-toggle="tab" href="#nav-new-user" role="tab">New User</a>
                </div>
            </nav>

            <div class="tab-content" id="nav-tabContent">
                <!-- Users Table -->
                <div class="tab-pane fade show active" id="nav-users" role="tabpanel">
                    <h3 class="mt-3">All users</h3>
                    <table class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Username</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone</th>
                            <th scope="col">Roles</th>
                            <th scope="col">Edit</th>
                            <th scope="col">Delete</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.id}"></td>
                            <td th:text="${user.username}"></td>
                            <td th:text="${user.email}"></td>
                            <td th:text="${user.phone}"></td>
                            <td th:text="${user.roles}"></td>
                            <td>
                                <!-- Кнопка для открытия модального окна -->
                            <button class="button button1"
                                    th:data-id="${user.getId()}"
                                    th:data-username="${user.getUsername()}"
                                    th:data-passoword="${user.getPassword()}"
                                    th:data-email="${user.getEmail()}"
                                    th:data-roles="${user.getRoles()}"
                                    data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
                            </td>
                            <td>
                                <button
                                        th:href="@{admin/delete?id={id}(id=${user.getId()})}"
                                        class="button button2"
                                        th:data-id="${user.getId()}"
                                        th:data-username="${user.getUsername()}"
                                        th:data-passoword="${user.getPassword()}"
                                        th:data-email="${user.getEmail()}"
                                        th:data-roles="${user.getRoles()}"
                                        data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
<!--                    Edit Modal-->
                    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
                        <form class="container" th:method="POST" th:action="@{/admin/change}" th:object="${user}" style="width: 400px">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                                        <button type="button" class="close btn-close" data-bs-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true"></span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="idE" style="font-weight: bold;">ID</label>
                                            <input type="text" readonly class="form-control" id="idE" name="id" th:value="${user.id}" style="background-color: #E9ECEF">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="usernameE" style="font-weight: bold">Username</label>
                                            <input type="text" class="form-control" id="usernameE" name="username" th:value="${user.username}">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="emailE" style="font-weight: bold">Email</label>
                                            <input type="email" class="form-control" id="emailE" name="email" th:value="${user.email}">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="passwordE" style="font-weight: bold">Password</label>
                                            <input type="password" class="form-control" id="passwordE" name="password" placeholder="Password">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="rolesE" style="font-weight: bold">Roles</label>
                                            <select multiple="multiple" th:field="*{roles}" class="form-control" id="rolesE" style="height: 60px;">
                                                <option th:each="role : ${allRoles}"
                                                        th:value="${role.id}"
                                                        th:text="${role.name}"
                                                        th:selected="${user.roles.contains(role)}">
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!--                    Edit Modal-->
                    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel">Delete User</h5>
                                    <button type="button" class="close btn-close" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true"></span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form class="container" style="width: 400px">
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="idD" style="font-weight: bold;">ID</label>
                                            <input type="text" class="form-control" id="idD" placeholder="ID" readonly style="color: #636E7A; background-color: #E9ECEF">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="usernameD" style="font-weight: bold">Username</label>
                                            <input type="text" class="form-control" id="usernameD" placeholder="Username" readonly style="color: #636E7A; background-color: #E9ECEF">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="emailD" style="font-weight: bold">Email</label>
                                            <input type="email" class="form-control" id="emailD" placeholder="Email" readonly style="color: #636E7A; background-color: #E9ECEF">
                                        </div>
                                        <div class="form-group">
                                            <label class="d-flex justify-content-center" for="rolesD" style="font-weight: bold">Roles</label>
                                            <select multiple="multiple" class="form-control" id="rolesD" style="height: 60px;" disabled>
                                                <!-- Roles should be displayed here if needed -->
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <a href="#" id="deleteConfirm" class="btn btn-danger">Delete</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- New User Form -->
                <div class="tab-pane fade" id="nav-new-user" role="tabpanel" aria-labelledby="nav-new-user-tab" tabindex="0">
                    <h3 class="mt-3">New User</h3>
                    <form th:action="@{/admin}" th:object="${newUser}" method="post">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" th:field="*{username}" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:field="*{email}" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone" th:field="*{phone}" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" th:field="*{password}" required>
                        </div>
                        <div class="mb-3">
                            <label for="roles" class="form-label">Roles</label>
                            <select multiple class="form-control" id="roles" name="roleIds">
                                <option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}"></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </form>
                </div>
            </div>

        </main>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>